name: Gamegoo Socket Server QA CI/CD

on:
  push:
    branches:
      - qa
  pull_request:
    types: [closed]
    branches:
      - develop
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      SOCKETIO_URL: ${{ secrets.QA_SOCKETIO_URL }}
      API_SERVER_URL: ${{ secrets.QA_API_SERVER_URL }}
      NODE_SERVER_URL: ${{ secrets.QA_NODE_SERVER_URL }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EC2_HOST: ${{ secrets.QA_EC2_HOST }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      EC2_LOG_PATH: ${{ secrets.EC2_LOG_PATH }}
      DISCORD_WEBHOOK_BACK_DEPLOY: ${{ secrets.DISCORD_WEBHOOK_BACK_DEPLOY }}

    steps:
      # 1) GitHub checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      # 3) npm install
      - name: Install dependencies
        run: npm install

      # 4) Docker Buildx ì„¤ì •
      - name: Docker Buildx setup
        uses: docker/setup-buildx-action@v3

      # 5) Docker Hub ë¡œê·¸ì¸
      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # 6) Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-qa
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/gamegoo-socket-qa:${{ github.sha }}
          platforms: linux/amd64
          build-args: |
            JWT_SECRET=${{ env.JWT_SECRET }}
            SOCKETIO_URL=${{ env.SOCKETIO_URL }}
            API_SERVER_URL=${{ env.API_SERVER_URL }}
            NODE_SERVER_URL=${{ env.NODE_SERVER_URL }}

      # 7) SSHë¡œ EC2 ì ‘ì†í•˜ì—¬ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }} # EC2 í¼ë¸”ë¦­ IP
          username: ubuntu
          key: ${{ env.EC2_SSH_KEY }} # SSH Private Key
          port: 22 # SSH í¬íŠ¸ (ê¸°ë³¸ 22)
          script_stop: true # ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
          script: |
            echo "Stopping existing container..."
            docker stop gamegoo-socket-qa || true
            echo "Removing existing container..."
            docker rm gamegoo-socket-qa || true

            echo "Pulling new Docker image..."
            docker pull ${{ env.DOCKERHUB_USERNAME }}/gamegoo-socket-qa:${{ github.sha }}

            echo "Running new Docker container..."
            docker run -d -p 3000:3000 \
              --name gamegoo-socket-qa \
              -v ${{ env.EC2_LOG_PATH }}:/app/logs \
              -e JWT_SECRET=${{ env.JWT_SECRET }} \
              -e SOCKETIO_URL=${{ env.SOCKETIO_URL }} \
              -e API_SERVER_URL=${{ env.API_SERVER_URL }} \
              -e NODE_SERVER_URL=${{ env.NODE_SERVER_URL }} \
              ${{ env.DOCKERHUB_USERNAME }}/gamegoo-socket-qa:${{ github.sha }}

      # ì‹¤íŒ¨ ì‹œ ë””ìŠ¤ì½”ë“œì— ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡
        if: failure() # ì´ì „ ìŠ¤í…ì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"ğŸš¨ **Gamegoo Socket QA ì„œë²„ ë°°í¬ ì‹¤íŒ¨** ğŸš¨\nPR ë²ˆí˜¸: ${PR_NUMBER}\nPR ì œëª©: ${PR_TITLE}\nPR ì‘ì„±ì: ${PR_AUTHOR}\n[PR ë³´ê¸°](${PR_URL})\"}" \
          $DISCORD_WEBHOOK_BACK_DEPLOY
